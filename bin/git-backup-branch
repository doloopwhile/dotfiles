#!/bin/bash
git_branch_exists() {
  git branch | cut -b 3- | grep -q "^${1}$" > /dev/null
}

get_tmp_branch_name() {
  prefix='bak/'
  local b="${prefix}${1}"
  if ! git_branch_exists "${b}" ;then
    echo "${b}"
    return 0
  fi

  for i in $(seq 2 100); do
    b="${prefix}${1}_${i}"
    if ! git_branch_exists "${b}"; then
      echo "${b}"
      return 0
    fi
  done

  return 1
}

main() {
  if [ $# -gt 2 ]; then
    echo 'usage: git backup-branch [BACKUP_BRANCH_NAME]' >&2
    exit 1
  fi

  branch=$(git rev-parse --abbrev-ref HEAD)

  if [ $# -eq 0 ]; then
    tmp_branch="$(get_tmp_branch_name "${branch}")"
    if [ "$?" -ne 0 ]; then
      echo "Could not allocate backup branch name" >&2
      exit 1
    fi
  else
    tmp_branch="$1"
  fi

  git branch "${tmp_branch}" && echo "Created backup branch '${tmp_branch}'"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
