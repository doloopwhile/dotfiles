#!/bin/bash
branch=$(git rev-parse --abbrev-ref HEAD)

function git_branch_exists() {
  git branch | cut -b 3- | grep -q "^${1}$" > /dev/null
}

function get_tmp_branch_name() {
  prefix='bak/'
  local b="${prefix}${1}"
  if ! git_branch_exists "${b}" ;then
    echo "${b}"
    return 0
  fi

  for i in $(seq 2 100); do
    b="${prefix}${1}_${i}"
    if ! git_branch_exists "${b}"; then
      echo "${b}"
      return 0
    fi
  done

  return 1
}

tmp_branch=$(get_tmp_branch_name "${branch}")
if [ "$?" -ne 0 ]; then
  echo "Could not allocate backup branch name" >&2
  exit 1
fi

git branch "${tmp_branch}" && echo "Created backup branch '${tmp_branch}'"
